<div class="page-container">
    <!-- 1. 接続設定 -->
    <mat-card>
        <mat-card-header>
            <mat-icon mat-card-avatar fontSet="material-icons-two-tone">dns</mat-icon>
            <mat-card-title>Step 1: データベース接続</mat-card-title>
            <mat-card-subtitle>出力元のデータベースを選択して接続します。</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="step-content">
            <mat-form-field appearance="outline" class="profile-select">
                <mat-label>接続プロファイル</mat-label>
                <mat-select [formControl]="profileControl" required>
                    <mat-option *ngFor="let profile of dbProfiles" [value]="profile">
                        {{ profile.name }} ({{ profile.user }}@{{profile.host}})
                    </mat-option>
                </mat-select>
                <mat-error *ngIf="profileControl.hasError('required')">プロファイルを選択してください</mat-error>
            </mat-form-field>
            <button mat-raised-button color="primary" [disabled]="!profileControl.valid || isLoading"
                (click)="connectToDb()">
                <mat-icon>power</mat-icon>
                接続
            </button>
        </mat-card-content>
    </mat-card>

    <mat-progress-bar mode="indeterminate" *ngIf="isLoading"></mat-progress-bar>

    <!-- 2. テーブル選択と出力 -->
    <mat-card *ngIf="tables.length > 0">
        <mat-card-header>
            <mat-icon mat-card-avatar fontSet="material-icons-two-tone">table_chart</mat-icon>
            <mat-card-title>Step 2: テーブル選択とデータ出力</mat-card-title>
            <mat-card-subtitle>テーブルを選択して内容をプレビューし、全件をZIPファイルとして出力します。</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content class="step-content">
            <mat-form-field appearance="outline" class="table-select">
                <mat-label>テーブル</mat-label>
                <mat-select [formControl]="tableControl" required (selectionChange)="onTableSelect($event.value)">
                    <mat-option *ngFor="let table of tables" [value]="table">
                        {{ table }}
                    </mat-option>
                </mat-select>
                <mat-error *ngIf="tableControl.hasError('required')">テーブルを選択してください</mat-error>
            </mat-form-field>
            <button mat-raised-button color="primary" [disabled]="!tableControl.valid || isLoading"
                (click)="exportData()">
                <mat-icon>archive</mat-icon>
                ZIPで出力
            </button>
        </mat-card-content>

        <!-- データプレビュー -->
        <div class="table-container" *ngIf="previewData.rows.length > 0">
            <p class="preview-title">データプレビュー (先頭100件)</p>
            <table mat-table [dataSource]="previewData.rows" class="mat-elevation-z2">
                <!-- 動的に列を生成 -->
                <ng-container *ngFor="let header of previewData.headers" [matColumnDef]="header">
                    <th mat-header-cell *matHeaderCellDef> {{header}} </th>
                    <td mat-cell *matCellDef="let row"> {{row[header]}} </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="previewData.headers; sticky: true"></tr>
                <tr mat-row *matRowDef="let row; columns: previewData.headers;"></tr>
            </table>
        </div>
    </mat-card>
</div>