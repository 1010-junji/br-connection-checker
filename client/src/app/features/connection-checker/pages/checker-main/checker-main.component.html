<div class="checker-container">
    <!-- モード選択カード -->
    <mat-card class="mode-selection-card">
        <mat-card-header>
            <mat-icon mat-card-avatar fontSet="material-icons-two-tone">power</mat-icon>
            <mat-card-title>コンポーネント間疎通チェッカー</mat-card-title>
            <mat-card-subtitle>コンポーネント間のネットワーク・ポート接続を確認します。</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content class="selection-controls">
            <!-- チェックモード選択 -->
            <mat-form-field appearance="outline" class="control-item">
                <mat-label>発信するコンポーネント</mat-label>
                <mat-select [value]="selectedMode" (selectionChange)="onModeChange($event.value)" [disabled]="isRunning">
                    <mat-option *ngFor="let mode of modes" [value]="mode.id">
                        {{ mode.name }}
                    </mat-option>
                </mat-select>
            </mat-form-field>
    
            <mat-form-field appearance="outline" class="control-item">
                <mat-label>利用するIPバージョン</mat-label>
                <mat-select [(ngModel)]="selectedIpFamily" [disabled]="isRunning">
                    <mat-option *ngFor="let family of ipFamilies" [value]="family.value">
                        {{ family.viewValue }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="control-item">
                <mat-label>自端末のFWチェック</mat-label>
                <mat-select [(ngModel)]="doPortScan" [disabled]="isRunning">
                    <mat-option value="no">しない</mat-option>
                    <mat-option value="yes">する</mat-option>
                </mat-select>
            </mat-form-field>
        </mat-card-content>

        <div *ngIf="doPortScan === 'yes'" class="notice-box">
            <mat-icon>warning_amber</mat-icon>
            <div>
                <strong>注意:</strong>
                <ul>
                    <li>1024番未満のポートをチェックするには管理者権限での実行が必要です。</li>
                    <li>チェック中は一時的にポートを確保します。(すでに使用中のポートがある場合、チェックに失敗する可能性があります。)</li>
                </ul>
            </div>
        </div>
    </mat-card>

    <ng-container *ngIf="config">
        <!-- 条件入力フォーム -->
        <mat-card class="form-card">
            <mat-card-content>
                <div class="grid-container">
                    <!-- 左半分: 入力フォーム -->
                    <div class="form-container">
                        <!-- チェック対象グループごとにループ -->
                        <div *ngFor="let target of config.checkTargets" class="check-target-group">
                            <h4 class="target-title">{{ target.title }}</h4>
                            <!-- 行ごとにループ -->
                            <div *ngFor="let row of target.fieldRows" class="form-row">
                                <!-- フィールドごとにループ -->
                                <mat-form-field *ngFor="let field of row.fields" [ngClass]="field.class"
                                    appearance="outline" class="dense-form-field">
                                    <mat-label>{{ field.label }}</mat-label>
                                    <input matInput [(ngModel)]="field.value" [type]="field.type"
                                        [disabled]="isRunning">
                                </mat-form-field>
                            </div>
                        </div>
                    </div>

                    <!-- 右半分: SVG画像 -->
                    <div class="image-container">
                        <div [ngSwitch]="selectedMode" class="svg-wrapper">
                            <app-das-svg *ngSwitchCase="'das'" [params]="getFormParams()"></app-das-svg>
                            <app-ds-svg *ngSwitchCase="'ds'" [params]="getFormParams()"></app-ds-svg>
                            <app-kapplets-svg *ngSwitchCase="'kapplets'" [params]="getFormParams()"></app-kapplets-svg>
                            <app-mc-svg *ngSwitchCase="'mc'" [params]="getFormParams()"></app-mc-svg>
                            <app-rs-svg *ngSwitchCase="'rs'" [params]="getFormParams()"></app-rs-svg>
                        </div>
                    </div>
                </div>
            </mat-card-content>
            <mat-card-actions align="end">
                <button mat-raised-button color="primary" (click)="runCheck()" [disabled]="isRunning || !config">
                    <mat-icon>play_arrow</mat-icon>
                    チェック実行
                </button>
            </mat-card-actions>
        </mat-card>

        <!-- 実行中のプログレスバー -->
        <mat-progress-bar mode="indeterminate" *ngIf="isRunning"></mat-progress-bar>

        <!-- 実行結果表示エリア -->
        <mat-card class="log-card">
            <mat-card-header>
                <mat-card-title>実行結果</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <pre #logContainer class="log-output" [innerHTML]="logOutput"></pre>
            </mat-card-content>
            <mat-card-actions align="end">
                <button mat-stroked-button color="primary" (click)="saveLog()" [disabled]="isRunning || !logOutput">
                    <mat-icon>save_alt</mat-icon>
                    結果をファイルに出力
                </button>
            </mat-card-actions>
        </mat-card>
    </ng-container>

    <!-- モードが選択されていない場合に表示するメッセージ -->
    <div *ngIf="!config && !isRunning" class="placeholder-container">
        <mat-icon class="placeholder-icon">rule</mat-icon>
        <p class="placeholder-text">上記ドロップダウンからチェックしたいコンポーネントを選択してください。</p>
    </div>
</div>